<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Qui s√≥c? ‚Äî Grease (v4.6a)</title>
<style>
  :root{--bg:#0e0d13;--panel:#17161f;--text:#f6f6fb;--accent:#ff2d55;--accent2:#ffd400;--muted:#cfcfe6;--ok:#32d74b;--bad:#ff453a;--line:#262433;
        --lightbtn:#e9e9ef;--lighttxt:#14131b;--blue:#2d7fff;}
  html,body{height:100%;margin:0;background:radial-gradient(circle at 30% 15%,rgba(255,45,85,.13),transparent 40%),radial-gradient(circle at 75% 85%,rgba(255,212,0,.10),transparent 45%),linear-gradient(180deg,#0b0a10 0%,#13121a 60%,#0b0a10 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Helvetica,Arial,Noto Sans,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}
  .wrap{max-width:1100px;margin:0 auto;padding:clamp(12px,3vw,28px)}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;margin:8px 0 10px}
  .brand h1{font-size:clamp(22px,5vw,44px);margin:0;font-weight:900;letter-spacing:.5px;text-shadow:0 0 6px rgba(255,45,85,.6),0 0 18px rgba(255,45,85,.45),0 0 30px rgba(255,212,0,.35)}
  .logo{width:160px;height:80px;object-fit:contain;border-radius:8px;background:#111;border:1px solid var(--line)}
  .menuPanel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35);backdrop-filter:blur(4px)}
  .menu{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{border:0;padding:10px 14px;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer}
  .btn.ok{background:linear-gradient(180deg,#32d74b,#1a8f2b);color:#fff;box-shadow:0 6px 20px rgba(50,215,75,.35)}
  .btn.gray{background:var(--lightbtn);color:var(--lighttxt);box-shadow:none;border:1px solid rgba(0,0,0,.08)}
  .btn.blue{background:var(--blue);color:#fff;box-shadow:0 6px 20px rgba(45,127,255,.35)}
  .btn.dark{background:#24232e;color:#ddd;box-shadow:none;border:1px solid rgba(255,255,255,.1)}
  .toggle{background:#24232e;color:#fff;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#24232e;color:#eee;font-size:12px;border:1px solid rgba(255,255,255,.08)}
  .timer{font-weight:900;font-size:18px;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#14131b}
  .timer.low{color:var(--bad);box-shadow:0 0 18px rgba(255,69,58,.35) inset}
  @keyframes blink { 50% { opacity: .3; } }
  .blink{ animation: blink .6s step-end infinite; }
  .progress{margin-left:auto;color:var(--muted);font-weight:700}
  .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:clamp(12px,2.8vw,22px);box-shadow:0 10px 30px rgba(0,0,0,.35);backdrop-filter:blur(4px);margin-top:14px}
  .game{margin-top:6px}
  .gameTop{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .clues{display:grid;gap:10px;margin:12px 0 16px}
  .clue{position:relative;background:#fff;color:#000;border-radius:14px;border:2px solid #000;padding:14px 14px;font-size:1.08rem;line-height:1.35;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .clue::before{content:attr(data-n);position:absolute;left:-10px;top:-12px;background:#ffd400;color:#000;font-weight:900;border-radius:999px;padding:6px 10px;border:2px solid #000;box-shadow:0 6px 16px rgba(255,212,0,.35)}
  .options{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px}
  .option{display:flex;align-items:center;gap:12px;background:#15141c;border:1px solid rgba(255,255,255,.09);border-radius:14px;padding:10px;cursor:pointer;transition:transform .06s ease;text-align:left}
  .option:hover{transform:translateY(-2px)}
  .option[disabled]{opacity:.55;pointer-events:none}
  .avatar{width:70px;height:70px;border-radius:10px;flex:0 0 70px;object-fit:cover;background:#26252f;border:1px solid rgba(255,255,255,.12)}
  .optText{font-weight:900;color:#fff}
  .feedback{margin-top:10px;font-weight:900;min-height:1.4em}
  .good{color:var(--ok)} .bad{color:var(--bad)}
  .score{display:flex;gap:12px;align-items:center;margin-top:6px;color:var(--muted);font-weight:800}
  .score strong{color:var(--text)}
  .hidden{display:none !important}
  .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);margin:14px 0}
  select,input[type=text]{background:#24232e;color:#fff;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px 12px;font-weight:700}
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55)}
  .modal.open{display:grid}
  .sheet{width:min(860px,92vw);background:#0f0e15;border:1px solid var(--line);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .sheet header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .sheet h3{margin:0}.sheet .content{padding:12px 14px;max-height:70vh;overflow:auto}
  .historyItem{display:grid;grid-template-columns:1fr auto auto;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px;margin-bottom:8px;background:#15141d}
  .historyItem small{color:var(--muted)}
  .caption{color:var(--muted);font-size:12px}
  .result{display:grid;gap:10px}
  .upper .wrap{ text-transform: uppercase; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><h1>Qui s√≥c?</h1></div>
      <img id="logoImg" class="logo" src="img/logo.jpg" alt="Logo del joc" />
    </div>

    <div class="menuPanel">
      <div class="menu">
        <button id="startBtn" class="btn gray">Nova partida</button>
        <button id="historyBtn" class="btn gray">Veure historial</button>
        <button id="soundBtn" class="toggle" aria-pressed="true">üîä Sons ON</button>
        <button id="capsBtn" class="toggle" aria-pressed="false">Maj√∫scules OFF</button>
        <button id="timeBtn" class="toggle" aria-pressed="true">Temps l√≠mit ON</button>
      </div>
    </div>

    <div class="panel">
      <div id="startConfig">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label>Mode de joc</label><br/>
            <select id="modeSel">
              <option value="infantil">Infantil (3‚Äì4 pistes, b√†sic)</option>
              <option value="normal" selected>Normal (4‚Äì5 pistes, barrejat)</option>
              <option value="expert">Expert (4‚Äì5, detalls exigents)</option>
              <option value="ultra">Ultra Expert (hiperconcret)</option>
            </select>
          </div>
          <div>
            <label>Nombre de rondes</label><br/>
            <select id="roundsSel">
              <option value="15" selected>15</option>
              <option value="30">30</option>
              <option value="60">60</option>
            </select>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label>Jugador 1 (nom)</label><br/>
            <input id="player1" type="text" placeholder="Escriu el teu nom" />
          </div>
          <div>
            <label>Mode Versus</label><br/>
            <select id="versusSel">
              <option value="off" selected>Un jugador</option>
              <option value="on">2 jugadors (versus)</option>
            </select>
          </div>
        </div>

        <div id="p2wrap" class="hidden" style="margin-bottom:10px">
          <label>Jugador 2 (nom)</label><br/>
          <input id="player2" type="text" placeholder="Nom del segon jugador" />
        </div>

        <div><button id="beginBtn" class="btn ok">Comen√ßar</button></div>
      </div>

      <div id="tutorial" class="hidden">
        <h3>Instruccions r√†pides</h3>
        <ul>
          <li>Prem <strong>Mostrar m√©s pistes</strong> si et quedes encallat.</li>
          <li>Tens <strong>20 segons</strong> per pregunta (si el temps l√≠mit √©s ON).</li>
          <li>En <strong>versus</strong> alternen torns.</li>
        </ul>
        <button id="goPlay" class="btn ok">Entesos! Anem a jugar</button>
      </div>

      <div id="gameArea" class="game hidden">
        <div class="gameTop">
          <div class="pill" id="turnInfo"></div>
          <div style="display:flex;gap:10px;align-items:center">
            <span class="timer" id="timer">‚è±Ô∏è 20</span>
            <span class="progress" id="progress">0 / 0</span>
            <button id="revealBtn" class="btn blue">Mostrar m√©s pistes</button>
            <button id="endGameBtn" class="btn dark">Sortir partida</button>
          </div>
        </div>
        <div class="clues" id="clues"></div>
        <div class="options" id="options"></div>
        <div class="feedback" id="feedback"></div>
        <div class="score" id="score">
          <div>Puntuaci√≥: <strong id="points">0</strong></div>
          <div>Ronda: <strong id="roundN">0</strong></div>
          <div class="pill" id="p2score" class="hidden"></div>
        </div>
      </div>

      <div id="resultPanel" class="hidden">
        <div class="result">
          <h3>Resultats</h3>
          <div id="resultSummary"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="playAgainBtn" class="btn ok">Jugar de nou</button>
            <button id="backToMenuBtn" class="btn gray">Tornar al men√∫</button>
            <button id="openHistoryBtn" class="btn gray">Veure historial</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="historyModal" role="dialog" aria-modal="true" aria-labelledby="histTitle">
    <div class="sheet">
      <header>
        <h3 id="histTitle">Historial de puntuacions</h3>
        <div style="display:flex;gap:8px">
          <button id="exportCSV" class="btn gray">Exporta CSV</button>
          <button id="clearHist" class="btn dark">Esborrar</button>
          <button id="closeHist" class="btn gray">Tanca</button>
        </div>
      </header>
      <div class="content" id="histContent"></div>
    </div>
  </div>

<script>
(function(){
  // Globals/state
  var BANK=[],round=0,revealed=0,current=null,remaining=[],tickInt=null,timeLeft=20,mode='normal',totalRounds=15,totalTime=0,questionT=0,versus=false,p1={name:'',points:0},p2={name:'',points:0},turn=1;
  var gameActive=false;
  var timeLimit=true;
  var capsOn=false;

  function $(id){ return document.getElementById(id); }

  var els={
    startBtn:null,historyBtn:null,soundBtn:null,logoImg:null,capsBtn:null,timeBtn:null,
    startConfig:null,beginBtn:null,versusSel:null,p2wrap:null,player1:null,player2:null,tutorial:null,goPlay:null,
    gameArea:null,turnInfo:null,timer:null,progress:null,revealBtn:null,endGameBtn:null,clues:null,options:null,feedback:null,points:null,roundN:null,p2score:null,
    modal:null,histContent:null,closeHist:null,clearHist:null,exportCSV:null,modeSel:null,roundsSel:null,
    resultPanel:null,resultSummary:null,playAgainBtn:null,backToMenuBtn:null,openHistoryBtn:null
  };

  var CHARACTERS=[
    {id:"sandy",name:"Sandy",img:"img/sandy.jpg",alt:"Sandy"},
    {id:"danny",name:"Danny",img:"img/danny.jpg",alt:"Danny"},
    {id:"rizzo",name:"Rizzo",img:"img/rizzo.jpg",alt:"Rizzo"},
    {id:"kenickie",name:"Kenickie",img:"img/kenickie.jpg",alt:"Kenickie"},
    {id:"frenchy",name:"Frenchy",img:"img/frenchy.jpg",alt:"Frenchy"},
    {id:"doody",name:"Doody",img:"img/doody.jpg",alt:"Doody"},
    {id:"marty",name:"Marty",img:"img/marty.jpg",alt:"Marty"},
    {id:"sonny",name:"Sonny",img:"img/sonny.jpg",alt:"Sonny"},
    {id:"putzie",name:"Putzie",img:"img/putzie.jpg",alt:"Putzie"},
    {id:"patty",name:"Patty",img:"img/patty.jpg",alt:"Patty Simcox"},
    {id:"jan",name:"Jan",img:"img/jan.jpg",alt:"Jan"},
    {id:"balmudo",name:"Balmudo",img:"img/balmudo.jpg",alt:"Leo Balmudo"},
    {id:"murdock",name:"Sra. Murdock",img:"img/murdock.jpg",alt:"Sra. Murdock"},
    {id:"tom",name:"Tom",img:"img/tom.jpg",alt:"Tom Chisum"},
    {id:"calhoun",name:"Entrenador Calhoun",img:"img/calhoun.jpg",alt:"Coach Calhoun"}
  ];

  var FACTS={
    sandy:{group:"amic de les Pink Ladies",locs:["Rydell High","el gimn√†s de Rydell","el Frosty Palace"],hair:"ros",pals:["la Frenchy"],duo:"Danny",notes:["Vaig arribar nova a l‚Äôescola.","Tinc un car√†cter amable.","Al final em faig un canvi de look."]},
    danny:{group:"T-Birds",locs:["Rydell High","el taller de l‚Äôescola","Thunder Road","el gimn√†s"],hair:"fosc",pals:["en Kenickie","en Sonny","en Putzie"],duo:"Sandy",notes:["M‚Äôagraden molt les curses de cotxes.","Sovint porto una jaqueta de cuir.","El meu pentinat √©s brillant."]},
    rizzo:{group:"l√≠der de les Pink Ladies",locs:["Rydell High","el gimn√†s"],hair:"fosc",pals:["la Marty","la Frenchy","la Jan"],duo:"Kenickie",notes:["Tinc una actitud valenta.","Faig comentaris enginyosos."]},
    kenickie:{group:"T-Birds",locs:["el taller","Thunder Road"],hair:"castany",pals:["en Danny","en Putzie"],duo:"Rizzo",notes:["S√≥c el manetes del grup.","Tinc un cotxe preparat per competir."]},
    frenchy:{group:"Pink Ladies",locs:["Rydell High","el Frosty Palace"],hair:"rosa a moments",pals:["la Sandy","la Marty","la Jan"],notes:["M‚Äôencanta el maquillatge.","Provo pentinats molt creatius."]},
    doody:{group:"T-Birds",locs:["Rydell High"],hair:"fosc",pals:["en Danny","en Kenickie","en Sonny","en Putzie"],notes:["A vegades toco la guitarra.","M‚Äôagrada fer bromes."]},
    marty:{group:"Pink Ladies",locs:["Rydell High","el Frosty Palace"],hair:"castany",pals:["la Rizzo","la Frenchy","la Jan"],notes:["Tinc debilitat per la moda i els accessoris.","M‚Äôagrada escriure cartes."]},
    sonny:{group:"T-Birds",locs:["Rydell High","el Frosty Palace"],hair:"castany",pals:["en Danny","en Kenickie","en Putzie"],notes:["Sempre estic de broma.","Parlo sovint de menjar."]},
    putzie:{group:"T-Birds",locs:["Rydell High"],hair:"clar",pals:["en Doody","en Danny"],notes:["S√≥c el bromista del grup.","Soc un amic lleial."]},
    patty:{group:"animadora",locs:["Rydell High","el gimn√†s"],hair:"ros",pals:["en Tom"],notes:["Organitzo activitats escolars.","Tinc molta energia i entusiasme."]},
    jan:{group:"Pink Ladies",locs:["Rydell High","el Frosty Palace"],hair:"castany clar",pals:["la Frenchy","la Marty","la Rizzo"],notes:["S√≥c riallera i divertida.","Sempre duc algun snack a m√†."]},
    balmudo:{group:"Scorpions",locs:["Thunder Road","un aparcament"],hair:"fosc",pals:["els Scorpions"],notes:["Condueixo de manera agressiva.","S√≥c rival dels T-Birds."]},
    murdock:{group:"professora de mec√†nica",locs:["el taller de l‚Äôescola"],hair:"castany",pals:[],notes:["Explico motors i eines.","Poso ex√†mens pr√†ctics."]},
    tom:{group:"jugador de futbol americ√†",locs:["el camp de Rydell","el gimn√†s"],hair:"clar",pals:["la Patty"],notes:["S√≥c molt popular.","Em passo hores entrenant."]},
    calhoun:{group:"entrenador de gimn√†s",locs:["el gimn√†s","el camp"],hair:"‚Äî",pals:["en Tom"],notes:["Dono instruccions amb energia.","Organitzo exercicis i partits."]},
  };

  var ULTRA=[
    {answer:"danny",clues:["Porto una camisa clara amb ratlles blaves a l‚Äôescena de la platja.","Apareixo a Thunder Road durant una cursa.","Al ball de l‚Äôescola em moc com un l√≠der.","A la colla, sovint decideixo el rumb."]},
    {answer:"balmudo",clues:["El meu cotxe mostra el n√∫mero 3 a Thunder Road.","S√≥c el rival directe dels T-Birds.","Condueixo de manera molt agressiva.","Formo part dels Scorpions."]},
    {answer:"murdock",clues:["Dirigeixo les pr√†ctiques de mec√†nica.","Se‚Äôm veu sovint al taller amb motors.","Explico les eines i els components amb detall.","Avalua els treballs t√®cnics dels alumnes."]},
    {answer:"marty",clues:["A l‚Äôinici porto un mocador de color vermell.","Sempre camino amb complements i joies.","Tinc escenes al Frosty Palace.","M‚Äôagrada escriure cartes elegants."]},
    {answer:"sandy",clues:["Comen√ßo t√≠mida i em transformo al final.","Comparteixo un moment clau al ball de l‚Äôescola.","Tinc un duet destacat amb en Danny.","Acabo amb un canvi de look sorprenent."]},
    {answer:"kenickie",clues:["S√≥c el propietari original del cotxe de la cursa.","Treballo sota el cap√≥ amb orgull.","Tinc rivalitats a la carretera.","Ballo sovint amb la Rizzo."]},
    {answer:"frenchy",clues:["Tinc una escena molt rosa a la perruqueria.","Dubto sobre el meu futur professional.","Faig de cor amable a l‚Äôequip.","Proposo pentinats molt cridaners."]},
    {answer:"tom",clues:["S√≥c jugador de futbol americ√†.","Tinc escenes d‚Äôentrenament al camp.","Tinc relaci√≥ amb la Patty.","Tinc un aspecte clarament atl√®tic."]},
    {answer:"patty",clues:["S√≥c animadora i organitzo esdeveniments.","Apareixo al gimn√†s animant tothom.","Mantinc un somriure i molta energia.","Participo a cerim√≤nies escolars."]},
    {answer:"jan",clues:["En una escena porto un look rosa.","Tinc un to rialler i alegre.","A vegades m‚Äôapar√®ixen snacks a la m√†.","Formo part de les Pink Ladies."]},
    {answer:"calhoun",clues:["Com a entrenador, faig que la gent pugi els genolls.","Dono ordres amb molta energia al gimn√†s.","Promoc la disciplina esportiva.","Tinc moments previs a un partit important."]},
    {answer:"putzie",clues:["Comparteixo bromes amb en Doody.","Se‚Äôm veu al pati fent riure els altres.","S√≥c un amic molt lleial.","Comparteixo escenes amb en Danny."]},
    {answer:"rizzo",clues:["Tinc un arc emocional intens.","Camino amb pas ferm i ulleres.","Lidero la colla sense por.","Comparteixo escenes potents amb en Kenickie."]},
    {answer:"sonny",clues:["Als descansos sempre penso en menjar.","Protagonitzo situacions c√≤miques.","Aparec al menjador i al pati.","Encara que faci bromes, s√≥c lleial."]},
    {answer:"doody",clues:["Acompanyo amb una guitarra en moments informals.","Aporto energia juvenil a la colla.","Quan cal, agafo el micro.","S√≥c amic proper d‚Äôen Putzie."]},
  ];

  function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
  function shuffle(a){ for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t;} return a; }

  var hairCounts=(function(){ var c={}; for(var k in FACTS){ var f=FACTS[k]; if(f && f.hair && f.hair!=='‚Äî'){ c[f.hair]=(c[f.hair]||0)+1; } } return c; })();
  function hairLine(id){ var f=FACTS[id]; if(!f || !f.hair || f.hair==='‚Äî') return null; var n=hairCounts[f.hair]||0; return (n<=1)?('Tinc els cabells de color '+f.hair+'.'):('S√≥c un dels personatges amb els cabells de color '+f.hair+'.'); }

  var SPECIAL=[
    {answer:"sandy", clues:["Qui se sembla m√©s la Nerine?" ]},
    {answer:"danny", clues:["La Bruna balla igual que en..?" ]},
  ];

  var HAND=[
    SPECIAL[0],SPECIAL[1],
    {answer:"danny",clues:["Formo part dels T-Birds.","M‚Äôagrada competir en curses de cotxes.","Porto brillantina al cabell.","Al ball vaig fer parella amb la Sandy."]},
    {answer:"sandy",clues:["Vaig arribar nova a Rydell.","M‚Äôagrada vestir amb colors clars.","S√≥c amable i canto de tant en tant.","Vaig ballar amb un noi de jaqueta de cuir."]},
    {answer:"rizzo",clues:["S√≥c la l√≠der de les Pink Ladies.","Tinc un car√†cter decidit i valent.","Parlo de manera directa.","Sovint ballo amb en Kenickie."]},
    {answer:"kenickie",clues:["Porto la jaqueta dels T-Birds.","S√≥c molt amic d‚Äôen Danny.","Tinc un cotxe preparat per competir.","Ballo amb la Rizzo."]},
    {answer:"frenchy",clues:["M‚Äôagrada el maquillatge i la perruqueria.","A vegades porto el cabell de color rosa.","S√≥c amiga de la Sandy.","Provo pentinats molt creatius."]},
    {answer:"marty",clues:["M‚Äôencanten els accessoris i la moda.","M‚Äôagrada escriure cartes maques.","Formo part de les Pink Ladies.","Porto mocadors i joies vistoses."]},
    {answer:"doody",clues:["De vegades toco la guitarra.","S√≥c dels T-Birds m√©s joves.","M‚Äôagrada fer bromes.","Tamb√© porto jaqueta negra com la colla."]},
    {answer:"sonny",clues:["Parlo molt de menjar i faig bromes.","S√≥c molt social amb la colla.","Formo part dels T-Birds.","El meu nom comen√ßa amb S."]},
    {answer:"putzie",clues:["S√≥c un T-Bird amb molta broma.","Comparteixo escenes amb en Doody.","Faig riure sovint els amics.","Vaig amb la colla a tot arreu."]},
    {answer:"patty",clues:["S√≥c animadora i parlo amb entusiasme.","Ajudo a organitzar esdeveniments a l‚Äôescola.","Mantinc una actitud molt positiva.","Sovint faig equip amb en Tom."]},
    {answer:"jan",clues:["S√≥c una Pink Lady divertida.","Tinc una rialla molt f√†cil.","Sempre tinc algun snack a m√†.","S√≥c amiga de la Frenchy i la Marty."]},
    {answer:"balmudo",clues:["Formo part dels Scorpions.","S√≥c rival declarat dels T-Birds.","Condueixo amb molta agressivitat.","Aparec a Thunder Road."]},
    {answer:"murdock",clues:["S√≥c professora de mec√†nica.","Treballo amb el grup al taller.","Explico els motors i les eines amb paci√®ncia.","Faig pr√†ctiques t√®cniques."]},
    {answer:"tom",clues:["S√≥c jugador de futbol americ√†.","Em veus entrenant al camp de Rydell.","S√≥c for√ßa popular.","Tinc relaci√≥ amb la Patty."]},
    {answer:"calhoun",clues:["S√≥c l‚Äôentrenador de gimn√†s.","Dono ordres amb energia.","Animo l‚Äôequip perqu√® rendeixi.","Se‚Äôm veu sovint al gimn√†s."]},
  ];

  function fromFacts(mode){
    var out=[];
    for(var ci=0; ci<CHARACTERS.length; ci++){
      var ch=CHARACTERS[ci];
      var f=FACTS[ch.id]; if(!f) continue;
      var base=[ 'Formo part de '+f.group+'.' ];
      if(f.locs && f.locs.length) base.push('Em veus sovint a '+pick(f.locs)+'.');
      var h=hairLine(ch.id); if(h) base.push(h);
      if(f.pals && f.pals.length) base.push('Tinc amistat amb '+pick(f.pals)+'.');
      if(f.duo) base.push('Sovint faig parella amb '+f.duo+'.');
      if(f.notes && f.notes.length){ for(var ni=0;ni<f.notes.length;ni++){ base.push(f.notes[ni]); } }
      var used={}, tries=0, target=(mode==='infantil')?6:10;
      function joinClues(arr){ return arr.join('|'); }
      while(countFor(ch.id,out)<target && tries<200){
        tries++;
        var n=(mode==='infantil')?Math.max(3,Math.min(4,base.length)):Math.max(4,Math.min(5,base.length));
        var s=shuffle(base.slice()).slice(0,n);
        var key=joinClues(s);
        if(!used[key]){ used[key]=1; out.push({answer:ch.id, clues:s}); }
      }
    }
    return out;
  }
  function countFor(id,arr){ var c=0; for(var i=0;i<arr.length;i++){ if(arr[i].answer===id) c++; } return c; }

  function choices(ans){
    var ids=[]; for(var i=0;i<CHARACTERS.length;i++){ ids.push(CHARACTERS[i].id); }
    var others=[]; for(i=0;i<ids.length;i++){ if(ids[i]!==ans) others.push(ids[i]); }
    others=shuffle(others).slice(0,3);
    var full=[ans]; for(i=0;i<others.length;i++) full.push(others[i]);
    return shuffle(full);
  }

  function buildBank(mode,rounds){
    var bank=HAND.slice().concat(fromFacts(mode));
    if(mode==='expert') bank=bank.concat(fromFacts('expert').slice(0,20));
    if(mode==='ultra') bank=bank.concat(ULTRA);
    for(var i=0;i<bank.length;i++){ bank[i]={answer:bank[i].answer,clues:bank[i].clues.slice(),choices:choices(bank[i].answer)}; }
    bank=shuffle(bank);
    var seen={}, unique=[];
    for(i=0;i<bank.length;i++){
      var q=bank[i]; var key=q.answer+'||'+q.clues.join('||');
      if(!seen[key]){ seen[key]=1; unique.push(q); }
      if(unique.length>=rounds*2) break;
    }
    unique=unique.slice(0, Math.min(rounds, unique.length));
    return unique;
  }

  // Audio
  var audioOn=true,actx=null;
  function beep(f,d,t,v){ if(!audioOn) return; try{ if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); } var o=actx.createOscillator(),g=actx.createGain(); o.type=t||'sine'; o.frequency.value=f||880; g.gain.value=v||0.08; o.connect(g).connect(actx.destination); o.start(); o.stop(actx.currentTime+(d||0.10)); }catch(e){} }
  function tickDown(){beep(520,0.065,'square',0.05)}
  function tickFinal(){beep(220,0.18,'square',0.08)}
  function sCorrect(){beep(1040,0.12,'triangle',0.09); setTimeout(function(){beep(1240,0.12,'triangle',0.09)},120);}
  function sWrong(){beep(300,0.12,'sawtooth',0.08); setTimeout(function(){beep(220,0.18,'sawtooth',0.08)},140);}

  var KEY='grease_v46a_index';
  function loadH(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); } catch(e){ return []; } }
  function saveH(a){ try{ localStorage.setItem(KEY, JSON.stringify(a)); }catch(e){} }
  function pushH(e){ var h=loadH(); h.unshift(e); saveH(h.slice(0,300)); }
  function showH(){
    var h=loadH(); els.histContent.innerHTML=h.length?'' : '<p>No hi ha partides guardades encara.</p>';
    for(var i=0;i<h.length;i++){
      var x=h[i]; var r=document.createElement('div'); r.className='historyItem';
      r.innerHTML='<div><strong>'+x.whenLabel+'</strong><br><small>'+x.rounds+' preguntes ¬∑ mode '+x.mode+(x.versus?' ¬∑ versus':'')+(x.p1?(' ¬∑ '+x.p1):'')+(x.p2?(' vs '+x.p2):'')+'</small></div>'+
                   '<div style="text-align:right">Punts<br><strong>'+x.points+'</strong></div>'+
                   '<div style="text-align:right">'+(x.versus?'Guanyador':'Temps mig')+'<br><small>'+(x.versus?(x.winner||'‚Äî'):((x.avgTime?x.avgTime.toFixed(1):'‚Äî')+'s'))+'</small></div>';
      els.histContent.appendChild(r);
    }
    $('historyModal').classList.add('open');
  }
  function exportCSV(){
    var h=loadH();
    var head=['data','mode','versus','jugador1','jugador2','rondes','punts_totals','p1_points','p2_points','guanyador','temps_mig_s'].join(',');
    var rows=[]; for(var i=0;i<h.length;i++){ var x=h[i]; rows.push([JSON.stringify(x.whenLabel),x.mode,x.versus,JSON.stringify(x.p1||''),JSON.stringify(x.p2||''),x.rounds,x.points,x.p1_points||'',x.p2_points||'',JSON.stringify(x.winner||''),(x.avgTime?x.avgTime.toFixed(2):'')].join(',')); }
    var csv=[head].concat(rows).join('\n');
    var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a'); a.href=url; a.download='grease_historial.csv'; a.click(); URL.revokeObjectURL(url);
  }

  function resetUI(){
    els.tutorial.classList.add('hidden');
    els.gameArea.classList.add('hidden');
    els.resultPanel.classList.add('hidden');
    els.startConfig.classList.remove('hidden');
    els.progress.textContent='0 / 0';
    els.feedback.textContent='';
    els.points.textContent='0';
    els.roundN.textContent='0';
    els.p2score.classList.add('hidden');
    els.clues.innerHTML='';
    els.options.innerHTML='';
  }
  function showResults(entry){
    els.resultSummary.innerHTML = entry.versus
      ? '<p><strong>Guanyador:</strong> '+(entry.winner || '‚Äî')+'</p><p><strong>'+entry.p1+':</strong> '+entry.p1_points+' punts</p><p><strong>'+entry.p2+':</strong> '+entry.p2_points+' punts</p><p><strong>Temps mig:</strong> '+(entry.avgTime?entry.avgTime.toFixed(1):'‚Äî')+'s</p>'
      : '<p><strong>Puntuaci√≥:</strong> '+entry.points+' punts</p><p><strong>Temps mig:</strong> '+(entry.avgTime?entry.avgTime.toFixed(1):'‚Äî')+'s</p>';
    els.gameArea.classList.add('hidden'); els.tutorial.classList.add('hidden'); els.startConfig.classList.add('hidden'); els.resultPanel.classList.remove('hidden');
  }
  function showMenu(){ gameActive=false; stopTimer(); resetUI(); }

  function startGame(){
    BANK=buildBank(mode,totalRounds);
    round=0; p1.points=0; p2.points=0; totalTime=0;
    remaining=[]; for(var i=0;i<BANK.length;i++){ remaining.push(i); }
    els.points.textContent='0'; els.roundN.textContent='0'; els.progress.textContent='0 / '+remaining.length;
    els.gameArea.classList.remove('hidden'); els.tutorial.classList.add('hidden'); els.startConfig.classList.add('hidden'); els.resultPanel.classList.add('hidden');
    turn=1; updateTurnInfo(); nextQuestion(); gameActive=true;
  }
  function updateTurnInfo(){ els.turnInfo.textContent=versus?('Torn de: '+(turn===1?p1.name:p2.name)):('Jugador: '+p1.name); }
  function nextQuestion(){
    if(tickInt){clearInterval(tickInt); tickInt=null;}
    if(round>=remaining.length){ finishGame(); return; }
    round++; els.roundN.textContent=round; els.feedback.textContent=''; revealed=0; els.revealBtn.disabled=false;
    current=BANK[remaining[round-1]]; renderClues(true); renderOptions(); els.progress.textContent=(round-1)+' / '+remaining.length;
    startTimer(); questionStart();
  }
  function renderClues(first){ els.clues.innerHTML=''; if(first) addClue(); }
  function addClue(){
    if(revealed>=current.clues.length){ els.revealBtn.disabled=true; return; }
    var d=document.createElement('div'); d.className='clue'; d.setAttribute('data-n', (revealed+1)); d.textContent=current.clues[revealed]; els.clues.appendChild(d); revealed++;
    if(revealed>=current.clues.length) els.revealBtn.disabled=true;
  }
  function renderOptions(){
    els.options.innerHTML='';
    var arr=shuffle(current.choices.slice());
    for(var i=0;i<arr.length;i++){
      var id=arr[i]; var ch=null; for(var j=0;j<CHARACTERS.length;j++){ if(CHARACTERS[j].id===id){ ch=CHARACTERS[j]; break; } }
      var b=document.createElement('button'); b.className='option'; b.dataset.id=id;
      var im=document.createElement('img'); im.className='avatar'; im.src=ch.img; im.alt=ch.alt||ch.name; im.onerror=function(){ this.style.opacity=.25; this.alt='Imatge no trobada'; };
      var t=document.createElement('div'); t.className='optText'; t.textContent=ch.name;
      b.appendChild(im); b.appendChild(t); b.addEventListener('click', onAnswer); els.options.appendChild(b);
    }
  }
  function onAnswer(e){
    var chosen=e.currentTarget.dataset.id;
    lock(); stopTimer(); questionEnd();
    var ok=(chosen===current.answer); score(ok);
    if(versus){ turn=(turn===1?2:1); updateTurnInfo(); }
    setTimeout(nextQuestion, 900);
  }
  function lock(){ var buttons=document.querySelectorAll('.option'); for(var i=0;i<buttons.length;i++){ buttons[i].disabled=true; } }
  function score(ok){
    var tgt=(versus && turn===2)?p2:p1;
    if(ok){
      var base=100, pen=Math.floor(base/Math.max(current.clues.length,1)), bonus=Math.max(0,timeLeft*2);
      var pts=Math.max(10, base - pen*(revealed-1)) + bonus;
      tgt.points+=pts; sCorrect();
      els.feedback.innerHTML='<span class="good">Correcte!</span> +'+pts+' punts (bonus temps: '+bonus+')';
    } else {
      var rightName=null; for(var i=0;i<CHARACTERS.length;i++){ if(CHARACTERS[i].id===current.answer){ rightName=CHARACTERS[i].name; break; } }
      sWrong(); els.feedback.innerHTML='<span class="bad">Temps esgotat o incorrecta.</span> La resposta correcta era <strong>'+rightName+'</strong>.';
    }
    els.points.textContent=p1.points;
    if(versus){ els.p2score.textContent=(p2.name+': '+p2.points+' punts'); els.p2score.classList.remove('hidden'); }
    els.progress.textContent=(round)+' / '+remaining.length;
  }

  function startTimer(){
    if(!timeLimit){ els.timer.style.display='none'; return; }
    els.timer.style.display='inline-block'; timeLeft=20; renderTimer();
    tickInt=setInterval(function(){
      timeLeft--; if(timeLeft<=3) tickDown(); renderTimer();
      if(timeLeft<=0){ tickFinal(); stopTimer(); lock(); questionEnd(); score(false); if(versus){ turn=(turn===1?2:1); updateTurnInfo(); } setTimeout(nextQuestion,900); }
    },1000);
  }
  function stopTimer(){ if(tickInt){ clearInterval(tickInt); tickInt=null; } }
  function renderTimer(){ els.timer.textContent='‚è±Ô∏è '+timeLeft; els.timer.classList[(timeLeft<=3)?'add':'remove']('low'); els.timer.classList[(timeLeft<=3)?'add':'remove']('blink'); }
  function questionStart(){ questionT=performance.now(); }
  function questionEnd(){
    if(questionT){ var dt=(performance.now()-questionT)/1000; var add = timeLimit ? Math.min(20, Math.max(0,dt)) : Math.max(0,dt); totalTime+=add; }
  }

  function finishGame(){
    gameActive=false; stopTimer(); questionEnd();
    var winner=null,total=p1.points;
    if(versus){ total+=p2.points; winner=(p1.points===p2.points)?'Empat':(p1.points>p2.points?p1.name:p2.name); }
    var now=new Date();
    var entry={ mode:mode,versus:versus,p1:p1.name,p2:versus?p2.name:null,p1_points:p1.points,p2_points:versus?p2.points:null,
      points:versus?(p1.points+p2.points):p1.points,rounds:remaining.length,avgTime:(totalTime/Math.max(remaining.length,1))||0,
      winner:winner,when:now.toISOString(),whenLabel:now.toLocaleString() };
    pushH(entry); showResults(entry);
  }
  function cancelGame(){
    if(!gameActive) return;
    if(!confirm('Vols sortir de la partida i tornar al men√∫? No es guardar√† a l‚Äôhistorial.')) return;
    gameActive=false; stopTimer(); resetUI();
  }

  function bindAll(){
    // Cache elements
    els.startBtn=$('startBtn'); els.historyBtn=$('historyBtn'); els.soundBtn=$('soundBtn'); els.logoImg=$('logoImg'); els.capsBtn=$('capsBtn'); els.timeBtn=$('timeBtn');
    els.startConfig=$('startConfig'); els.beginBtn=$('beginBtn'); els.versusSel=$('versusSel'); els.p2wrap=$('p2wrap'); els.player1=$('player1'); els.player2=$('player2'); els.tutorial=$('tutorial'); els.goPlay=$('goPlay');
    els.gameArea=$('gameArea'); els.turnInfo=$('turnInfo'); els.timer=$('timer'); els.progress=$('progress'); els.revealBtn=$('revealBtn'); els.endGameBtn=$('endGameBtn'); els.clues=$('clues'); els.options=$('options'); els.feedback=$('feedback'); els.points=$('points'); els.roundN=$('roundN'); els.p2score=$('p2score');
    els.modal=$('historyModal'); els.histContent=$('histContent'); els.closeHist=$('closeHist'); els.clearHist=$('clearHist'); els.exportCSV=$('exportCSV'); els.modeSel=$('modeSel'); els.roundsSel=$('roundsSel');
    els.resultPanel=$('resultPanel'); els.resultSummary=$('resultSummary'); els.playAgainBtn=$('playAgainBtn'); els.backToMenuBtn=$('backToMenuBtn'); els.openHistoryBtn=$('openHistoryBtn');

    // Logo fallback
    els.logoImg.onerror=function(){ els.logoImg.style.display='none'; };

    // Menu
    els.startBtn.addEventListener('click',function(){ resetUI(); els.startConfig.classList.remove('hidden'); });
    els.historyBtn.addEventListener('click', showH);
    els.soundBtn.addEventListener('click',function(e){ audioOn=!audioOn; e.currentTarget.setAttribute('aria-pressed',String(audioOn)); e.currentTarget.textContent=audioOn?'üîä Sons ON':'üîá Sons OFF'; });
    els.capsBtn.addEventListener('click',function(e){ capsOn=!capsOn; document.body.classList.toggle('upper',capsOn); e.currentTarget.setAttribute('aria-pressed',String(capsOn)); e.currentTarget.textContent=capsOn?'Maj√∫scules ON':'Maj√∫scules OFF'; });
    els.timeBtn.addEventListener('click',function(e){ timeLimit=!timeLimit; e.currentTarget.setAttribute('aria-pressed',String(timeLimit)); e.currentTarget.textContent=timeLimit?'Temps l√≠mit ON':'Temps l√≠mit OFF'; if(!timeLimit){ stopTimer(); els.timer.style.display='none'; } else { if(!els.gameArea.classList.contains('hidden')){ stopTimer(); startTimer(); } } });

    // Config
    els.versusSel.addEventListener('change',function(){ if(els.versusSel.value!=='on') els.p2wrap.classList.add('hidden'); else els.p2wrap.classList.remove('hidden'); });
    els.beginBtn.addEventListener('click',function(){ mode=els.modeSel.value; totalRounds=parseInt(els.roundsSel.value,10)||15; var n1=els.player1.value.trim(); if(!n1){alert('Introdueix el nom del Jugador 1.'); return;} p1={name:n1,points:0}; versus=(els.versusSel.value==='on'); if(versus){ var n2=els.player2.value.trim(); if(!n2){alert('Introdueix el nom del Jugador 2.'); return;} p2={name:n2,points:0}; els.p2score.classList.remove('hidden'); els.p2score.textContent=p2.name+': 0 punts'; } else { els.p2score.classList.add('hidden'); } els.startConfig.classList.add('hidden'); els.tutorial.classList.remove('hidden'); });
    els.goPlay.addEventListener('click',function(){ startGame(); });

    // Game
    els.revealBtn.addEventListener('click',function(){ if(!els.gameArea.classList.contains('hidden')) addClue(); });
    els.endGameBtn.addEventListener('click', cancelGame);
    window.addEventListener('keydown',function(e){ var k=(e.key||'').toLowerCase(); if(k==='h' && !els.gameArea.classList.contains('hidden') && !els.revealBtn.disabled) addClue(); if(k==='m') els.soundBtn.click(); });

    // History
    els.closeHist.addEventListener('click',function(){ $('historyModal').classList.remove('open'); });
    els.clearHist.addEventListener('click',function(){ try{ localStorage.removeItem(KEY); }catch(e){} showH(); });
    els.exportCSV.addEventListener('click', exportCSV);

    // Results
    els.playAgainBtn.addEventListener('click', function(){ resetUI(); els.tutorial.classList.remove('hidden'); });
    els.backToMenuBtn.addEventListener('click', showMenu);
    els.openHistoryBtn.addEventListener('click', showH);
  }

  function init(){ try{ bindAll(); } catch(e){ console.error('Init error', e); alert('Hi ha hagut un error inicialitzant el joc. Prova de refrescar (Ctrl/Cmd+F5).'); } }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }

})();</script>
</body>
</html>
